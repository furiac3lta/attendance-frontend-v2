<mat-card class="attendance-container">

  <h2>Lista de clases creadas - {{ selectedCourseName }}</h2>
  <p class="date-label">{{ currentDate }}</p>

  <mat-form-field appearance="outline" class="full-width">
    <mat-label>Observaciones</mat-label>
    <textarea matInput [(ngModel)]="newClassObservations" rows="3"></textarea>
  </mat-form-field>

  <div class="center-actions">
    <button mat-raised-button color="primary" (click)="createClass()">
      Crear nueva clase
    </button>
  </div>

  <button mat-stroked-button color="accent" class="report-btn" (click)="goToReport()" *ngIf="proPlan">
    Ver reporte mensual
  </button>

  <mat-slide-toggle
    class="inactive-toggle"
    [(ngModel)]="showInactive"
    (change)="toggleInactiveView()"
    *ngIf="canDeleteClass()">
    Ver inactivas
  </mat-slide-toggle>

  <mat-divider></mat-divider>

  <div class="class-cards" *ngIf="classes.length > 0">
    <article class="class-card" *ngFor="let c of classes">
      <div class="class-card__head">
        <div>
          <div class="class-title">{{ c.name }}</div>
          <div class="class-date">{{ c.date | date:'dd/MM/yyyy' }}</div>
          <div class="class-date" *ngIf="c.observations">
            Observaciones: {{ c.observations }}
          </div>
        </div>
        <span
          class="status-pill"
          [ngClass]="c.active === false ? 'status-inactive' : (c.attendanceTaken ? 'status-ok' : 'status-pending')">
          {{ c.active === false ? 'Inactiva' : (c.attendanceTaken ? 'Tomada' : 'No tomada') }}
        </span>
      </div>

      <div class="class-taken">
        <ng-container *ngIf="c.attendanceTaken; else noAttendanceCard">
          <div class="taken-by">
            <div>
              <strong>{{ c.takenByName }}</strong>
              <span class="role-badge role-{{ c.takenByRole }}">
                {{ c.takenByRole }}
              </span>
            </div>
            <span class="taken-at">
              {{ c.takenAt | date:'dd/MM/yyyy HH:mm' }}
            </span>
          </div>
        </ng-container>
        <ng-template #noAttendanceCard>
          <span class="no-attendance">No tomada</span>
        </ng-template>
      </div>

      <div class="class-actions">
        <button mat-raised-button color="primary"
                *ngIf="c.active !== false && !c.attendanceTaken"
                (click)="goToAttendance(c.id)">
          Tomar
        </button>

        <button
          mat-stroked-button
          color="primary"
          *ngIf="c.active !== false && canUseQr(c)"
          (click)="generateQr(c)">
          Generar QR
        </button>

        <button mat-raised-button color="warn"
                *ngIf="c.active !== false && c.attendanceTaken"
                (click)="goToAttendance(c.id)">
          Editar
        </button>

        <button
          mat-stroked-button
          color="primary"
          *ngIf="c.active !== false && canUseQr(c)"
          (click)="generateQr(c)">
          Generar QR
        </button>

        <button mat-raised-button color="accent"
                *ngIf="c.active !== false && c.attendanceTaken"
                (click)="viewAttendance(c.id)">
          Ver
        </button>

        <mat-slide-toggle
          class="delete-toggle"
          color="warn"
          [checked]="c.active !== false"
          [disabled]="!canDeleteClass()"
          (change)="toggleClassActive(c, $event)">
          Activa
        </mat-slide-toggle>
      </div>
    </article>
  </div>

  <div class="table-wrapper" *ngIf="classes.length > 0">
    <table mat-table [dataSource]="classes" class="table-modern">

    <!-- Clase -->
    <ng-container matColumnDef="name">
      <th mat-header-cell *matHeaderCellDef>Clase</th>
      <td mat-cell *matCellDef="let c">{{ c.name }}</td>
    </ng-container>

    <!-- Fecha -->
    <ng-container matColumnDef="date">
      <th mat-header-cell *matHeaderCellDef>Fecha</th>
      <td mat-cell *matCellDef="let c">
        {{ c.date | date:'dd/MM/yyyy' }}
      </td>
    </ng-container>

    <!-- Observaciones -->
    <ng-container matColumnDef="observations">
      <th mat-header-cell *matHeaderCellDef>Observaciones</th>
      <td mat-cell *matCellDef="let c">
        {{ c.observations || '—' }}
      </td>
    </ng-container>

    <!-- Tomada por -->
 <ng-container matColumnDef="takenBy">
  <th mat-header-cell *matHeaderCellDef>Tomada por</th>
  <td mat-cell *matCellDef="let c">

    <ng-container *ngIf="c.attendanceTaken; else noAttendance">
      <div class="taken-by">
        <div>
          <strong>{{ c.takenByName }}</strong>
          <span class="role-badge role-{{ c.takenByRole }}">
            {{ c.takenByRole }}
          </span>
        </div>
        <span class="taken-at">
          {{ c.takenAt | date:'dd/MM/yyyy HH:mm' }}
        </span>
      </div>
    </ng-container>

    <ng-template #noAttendance>
      <span class="no-attendance">No tomada</span>
    </ng-template>

  </td>
</ng-container>


    <!-- Acción -->
    <ng-container matColumnDef="action">
      <th mat-header-cell *matHeaderCellDef>Asistencia</th>
      <td mat-cell *matCellDef="let c">

        <button mat-raised-button color="primary"
                *ngIf="c.active !== false && !c.attendanceTaken"
                (click)="goToAttendance(c.id)">
          Tomar
        </button>

        <button mat-raised-button color="warn"
                *ngIf="c.active !== false && c.attendanceTaken"
                (click)="goToAttendance(c.id)">
          Editar
        </button>

        <button
          mat-stroked-button
          color="primary"
          *ngIf="c.active !== false && canUseQr(c)"
          (click)="generateQr(c)">
          Generar QR
        </button>

        <button mat-raised-button color="accent"
                *ngIf="c.active !== false && c.attendanceTaken"
                (click)="viewAttendance(c.id)">
          Ver
        </button>

        <mat-slide-toggle
          class="delete-toggle"
          color="warn"
          [checked]="c.active !== false"
          [disabled]="!canDeleteClass()"
          (change)="toggleClassActive(c, $event)">
          Activa
        </mat-slide-toggle>

      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="['name','date','observations','takenBy','action']"></tr>
    <tr mat-row *matRowDef="let row; columns: ['name','date','observations','takenBy','action']"></tr>

    </table>
  </div>

</mat-card>
