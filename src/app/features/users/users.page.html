<mat-card class="page-card users-page">

  <!-- ===================== -->
  <!-- T√çTULO -->
  <!-- ===================== -->
  <h2 class="title main-title">Gesti√≥n de Usuarios</h2>

  <div class="users-layout">

    <!-- ===================== -->
    <!-- üîç BUSCADOR / FILTROS -->
    <!-- ===================== -->
    <div class="section-card">
      <h3 class="section-title">Buscador</h3>

      <div class="filters-chip-container">

        <!-- Buscar -->
        <mat-form-field appearance="outline" class="filter-text">
          <mat-label>Buscar...</mat-label>
          <input
            matInput
            [(ngModel)]="searchTerm"
            (input)="applyFilter()">
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>

        <!-- Rol -->
        <div class="chip-filter-block">
          <h2 class="chip-title">Rol:</h2>
          <mat-chip-listbox
            class="chip-row"
            [(ngModel)]="filterRole"
            (ngModelChange)="applyFilter()">

            <mat-chip-option value="ALL">Todos</mat-chip-option>
            <mat-chip-option value="USER">Usuario</mat-chip-option>
            <mat-chip-option value="INSTRUCTOR">Instructor</mat-chip-option>
            <mat-chip-option value="ADMIN">Administrador</mat-chip-option>

            <mat-chip-option
              value="SUPER_ADMIN"
              *ngIf="currentRole === 'SUPER_ADMIN'">
              Super Admin
            </mat-chip-option>

          </mat-chip-listbox>
        </div>

        <!-- Curso -->
        <div class="chip-filter-block">
          <h2 class="chip-title">Curso:</h2>
          <mat-chip-listbox
            class="chip-row"
            [(ngModel)]="filterCourse"
            (ngModelChange)="applyFilter()">

            <mat-chip-option value="ALL">Todos</mat-chip-option>

            <mat-chip-option
              *ngFor="let c of courses"
              [value]="c.id">
              {{ c.name }}
            </mat-chip-option>

          </mat-chip-listbox>
        </div>

      </div>
    </div>

    <!-- ===================== -->
    <!-- üìã LISTADO DE USUARIOS -->
    <!-- ===================== -->
    <div class="section-card section-table">
      <h3 class="section-title">Listado de usuarios</h3>

      <div class="table-section">

        <table
          mat-table
          [dataSource]="users"
          class="table-modern responsive-table">

          <!-- NOMBRE -->
          <ng-container matColumnDef="fullName">
            <th mat-header-cell *matHeaderCellDef>Nombre</th>
            <td mat-cell *matCellDef="let u">{{ u.fullName }}</td>
          </ng-container>

          <!-- EMAIL -->
          <ng-container matColumnDef="email">
            <th mat-header-cell *matHeaderCellDef>Email</th>
            <td mat-cell *matCellDef="let u">{{ u.email }}</td>
          </ng-container>

          <!-- ROL -->
          <ng-container matColumnDef="role">
            <th mat-header-cell *matHeaderCellDef>Rol</th>
            <td mat-cell *matCellDef="let u">{{ u.role }}</td>
          </ng-container>

          <!-- ORGANIZACI√ìN -->
          <ng-container matColumnDef="organization">
            <th mat-header-cell *matHeaderCellDef>Organizaci√≥n</th>
            <td mat-cell *matCellDef="let u">
              {{ u.organizationName || 'Sin asignar' }}
            </td>
          </ng-container>

          <!-- CURSOS -->
          <ng-container matColumnDef="cursosAsignados">
            <th mat-header-cell *matHeaderCellDef>Cursos</th>
            <td mat-cell *matCellDef="let u">
              <mat-chip-set>
                <mat-chip *ngFor="let c of u.courses">
                  {{ c }}
                </mat-chip>
                <mat-chip *ngIf="!u.courses?.length">
                  Sin cursos
                </mat-chip>
              </mat-chip-set>
            </td>
          </ng-container>

          <!-- üí∞ CUOTA -->
          <ng-container matColumnDef="paid">
            <th mat-header-cell *matHeaderCellDef>Cuota</th>
            <td mat-cell *matCellDef="let u" class="quota-cell">

              <!-- SOLO si hay curso filtrado -->
              <ng-container *ngIf="filterCourse !== 'ALL'; else noCourse">

                <mat-icon
                  [ngClass]="paymentStatus[u.id] ? 'paid-ok' : 'paid-bad'"
                  matTooltip="{{ paymentStatus[u.id] ? 'Cuota al d√≠a' : 'Cuota pendiente' }}">
                  {{ paymentStatus[u.id] ? 'check_circle' : 'cancel' }}
                </mat-icon>

              </ng-container>

              <!-- Cuando NO hay curso -->
              <ng-template #noCourse>
                <span class="text-muted">‚Äî</span>
              </ng-template>

            </td>
          </ng-container>

          <!-- ACCIONES -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Acciones</th>
            <td mat-cell *matCellDef="let u">

              <button mat-icon-button (click)="editUser(u)">
                <mat-icon>edit</mat-icon>
              </button>

              <button mat-icon-button color="warn" (click)="deleteUser(u.id)">
                <mat-icon>delete</mat-icon>
              </button>

              <button
                mat-icon-button
                color="primary"
                matTooltip="Registrar pago"
                (click)="goToRegisterPayment(u)">
                <mat-icon>payments</mat-icon>
              </button>

            </td>
          </ng-container>

          <!-- HEADER -->
          <tr mat-header-row *matHeaderRowDef="[
            'fullName',
            'email',
            'role',
            'organization',
            'cursosAsignados',
            'paid',
            'actions'
          ]"></tr>

          <!-- ROW -->
          <tr mat-row *matRowDef="let row; columns: [
            'fullName',
            'email',
            'role',
            'organization',
            'cursosAsignados',
            'paid',
            'actions'
          ]"></tr>

        </table>

      </div>
    </div>

  </div>
</mat-card>
