<mat-card class="page-card">
  <div class="page-head">
    <h2 class="page-head__title">{{ title }}</h2>
  </div>

  <div class="scan-actions" *ngIf="isUser && proPlan">
    <button mat-raised-button color="primary" routerLink="/attendance/scan">
      Escanear QR
    </button>
  </div>

  <section class="section-card" *ngIf="isOwnPanel">
    <h3 class="section-title">Cambiar contraseña</h3>
    <form class="password-form" (ngSubmit)="updateOwnPassword()">
      <mat-form-field appearance="outline">
        <mat-label>Contraseña actual</mat-label>
        <input matInput type="password" [(ngModel)]="currentPassword" name="currentPassword">
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Nueva contraseña</mat-label>
        <input matInput type="password" [(ngModel)]="newPassword" name="newPassword">
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Confirmar nueva contraseña</mat-label>
        <input matInput type="password" [(ngModel)]="confirmPassword" name="confirmPassword">
      </mat-form-field>
      <button mat-raised-button color="primary" type="submit" [disabled]="updatingPassword">
        {{ updatingPassword ? 'Guardando...' : 'Actualizar contraseña' }}
      </button>
    </form>
  </section>

  <div *ngIf="loading" class="muted">Cargando historial...</div>

  <div *ngIf="!loading && !proPlan" class="muted">
    Algunas secciones requieren plan PRO (pagos y asistencias completas).
  </div>

  <ng-container *ngIf="!loading && history">
    <section class="history-grid">
      <article class="section-card">
        <h3 class="section-title">Datos personales</h3>
        <div class="personal-grid">
          <div>
            <div class="personal-label">Nombre</div>
            <div class="personal-value">{{ history.fullName }}</div>
          </div>
          <div>
            <div class="personal-label">Rol</div>
            <div class="personal-value">{{ history.role }}</div>
          </div>
          <div>
            <div class="personal-label">Email</div>
            <div class="personal-value">{{ history.email }}</div>
          </div>
          <div *ngIf="!canEditPersonal">
            <div class="personal-label">DNI</div>
            <div class="personal-value">{{ history.dni || '—' }}</div>
          </div>
          <div *ngIf="!canEditPersonal">
            <div class="personal-label">Teléfono</div>
            <div class="personal-value">{{ history.phone || '—' }}</div>
          </div>
          <div *ngIf="!canEditPersonal">
            <div class="personal-label">Domicilio</div>
            <div class="personal-value">{{ history.address || '—' }}</div>
          </div>
        </div>
        <form class="personal-form" *ngIf="canEditPersonal" (ngSubmit)="updatePersonalData()">
          <mat-form-field appearance="outline">
            <mat-label>DNI</mat-label>
            <input matInput [(ngModel)]="personalDni" name="personalDni">
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Teléfono</mat-label>
            <input matInput [(ngModel)]="personalPhone" name="personalPhone">
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Domicilio</mat-label>
            <input matInput [(ngModel)]="personalAddress" name="personalAddress">
          </mat-form-field>
          <button mat-raised-button color="primary" type="submit" [disabled]="updatingPersonal">
            {{ updatingPersonal ? 'Guardando...' : 'Guardar datos' }}
          </button>
        </form>
      </article>

      <article class="section-card">
        <h3 class="section-title">Observaciones</h3>
        <p *ngIf="history.observations; else noObs">{{ history.observations }}</p>
        <ng-template #noObs>
          <p class="muted">Sin observaciones.</p>
        </ng-template>
      </article>

      <article class="section-card">
        <h3 class="section-title">Cursos </h3>
        <mat-chip-set>
          <mat-chip *ngFor="let c of history.courses">{{ c.name }}</mat-chip>
          <mat-chip *ngIf="!history.courses?.length">Sin cursos</mat-chip>
        </mat-chip-set>
      </article>
    </section>

    <section class="section-card">
      <h3 class="section-title">Asistencias</h3>
      <div class="attendance-cards" *ngIf="history.attendances?.length">
        <article class="attendance-card" *ngFor="let a of history.attendances">
          <div class="card-head">
            <div>
              <div class="card-title">{{ a.courseName }}</div>
              <div class="card-subtitle">{{ a.takenAt | date:'dd/MM/yyyy' }}</div>
            </div>
            <span class="status-pill" [ngClass]="a.attended ? 'status-paid' : 'status-unpaid'">
              {{ a.attended ? 'Presente' : 'Ausente' }}
            </span>
          </div>
          <div class="card-row">
            <span class="label">Observaciones</span>
            <span class="value">{{ a.classObservations || '—' }}</span>
          </div>
        </article>
      </div>
      <table mat-table [dataSource]="history.attendances || []" class="table-modern attendance-table">
        <ng-container matColumnDef="date">
          <th mat-header-cell *matHeaderCellDef>Fecha</th>
          <td mat-cell *matCellDef="let a">{{ a.takenAt | date:'dd/MM/yyyy' }}</td>
        </ng-container>
        <ng-container matColumnDef="course">
          <th mat-header-cell *matHeaderCellDef>Curso</th>
          <td mat-cell *matCellDef="let a">{{ a.courseName }}</td>
        </ng-container>
        <ng-container matColumnDef="observations">
          <th mat-header-cell *matHeaderCellDef>Observaciones</th>
          <td mat-cell *matCellDef="let a">{{ a.classObservations || '—' }}</td>
        </ng-container>
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Estado</th>
          <td mat-cell *matCellDef="let a">
            {{ a.attended ? 'Presente' : 'Ausente' }}
          </td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="attendanceColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: attendanceColumns"></tr>
      </table>
    </section>

    <section class="section-card">
      <h3 class="section-title">Pagos</h3>
      <div class="payment-cards" *ngIf="history.payments?.length">
        <article class="payment-card" *ngFor="let p of history.payments">
          <div class="card-head">
            <div>
              <div class="card-title">{{ p.month }}/{{ p.year }}</div>
              <div class="card-subtitle">{{ p.amount | currency:'$':'symbol':'1.0-0' }}</div>
            </div>
            <span class="status-pill" [ngClass]="p.status === 'PAID' ? 'status-paid' : 'status-unpaid'">
              {{ p.status === 'PAID' ? 'Pagado' : 'Pendiente' }}
            </span>
          </div>
        </article>
      </div>
      <table mat-table [dataSource]="history.payments || []" class="table-modern payment-table">
        <ng-container matColumnDef="month">
          <th mat-header-cell *matHeaderCellDef>Mes</th>
          <td mat-cell *matCellDef="let p">{{ p.month }}/{{ p.year }}</td>
        </ng-container>
        <ng-container matColumnDef="amount">
          <th mat-header-cell *matHeaderCellDef>Monto</th>
          <td mat-cell *matCellDef="let p">{{ p.amount | currency:'$':'symbol':'1.0-0' }}</td>
        </ng-container>
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Estado</th>
          <td mat-cell *matCellDef="let p">
            <span class="status-pill" [ngClass]="p.status === 'PAID' ? 'status-paid' : 'status-unpaid'">
              {{ p.status === 'PAID' ? 'Pagado' : 'Pendiente' }}
            </span>
          </td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="paymentColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: paymentColumns"></tr>
      </table>
    </section>
  </ng-container>
</mat-card>
