<mat-card class="take-card">

  <h2>Tomar asistencia</h2>

  <mat-divider></mat-divider>

  <div class="class-info">
    <p><strong>Clase:</strong> {{ className }}</p>
    <p><strong>Curso:</strong> {{ courseName }}</p>
    <p><strong>Fecha:</strong> {{ date | date:'dd/MM/yyyy' }}</p>
    <p *ngIf="classObservations"><strong>Observaciones:</strong> {{ classObservations }}</p>
    <p *ngIf="qrEnabled" class="muted"><strong>QR activo:</strong> también podés marcar asistencia manualmente.</p>
  </div>

  <mat-divider></mat-divider>

  <div *ngIf="students.length === 0" class="loading">
    Cargando alumnos…
  </div>

  <div class="attendance-cards" *ngIf="students.length > 0">
    <article class="attendance-card" *ngFor="let s of students">
      <div class="card-head">
        <div class="card-title">{{ s.fullName }}</div>
      </div>

      <div class="card-grid">
        <div class="card-row" *ngIf="proPlan">
          <span class="label">Cuota</span>
          <span class="value">
            <span
              class="pill-button"
              [ngClass]="s.paid ? 'pill-ok' : 'pill-bad'">
              <span class="pill-icon" aria-hidden="true">
                <mat-icon>
                  {{ s.paid ? 'check' : 'close' }}
                </mat-icon>
              </span>
              {{ s.paid ? 'Al día' : 'Vencida' }}
            </span>
          </span>
        </div>
        <div class="card-row">
          <span class="label">Asistencia</span>
          <span class="value">
            <button
              type="button"
              class="pill-button presence-toggle"
              [ngClass]="getMark(s.id) ? 'pill-ok' : 'pill-bad'"
              type="button"
              (click)="toggleAttendance(s.id, !getMark(s.id))"
              [attr.aria-pressed]="getMark(s.id)">
              <span class="pill-icon" aria-hidden="true">
                <mat-icon>
                  {{ getMark(s.id) ? 'check' : 'close' }}
                </mat-icon>
              </span>
              {{ getMark(s.id) ? 'Presente' : 'Ausente' }}
            </button>
          </span>
        </div>
      </div>
    </article>
  </div>

  <div class="table-wrapper" *ngIf="students.length > 0">
    <table
      mat-table
      [dataSource]="students"
      class="table-modern"
    >

    <!-- ===================== -->
    <!-- Alumno                -->
    <!-- ===================== -->
    <ng-container matColumnDef="name">
      <th mat-header-cell *matHeaderCellDef> Alumno </th>
      <td mat-cell *matCellDef="let s" class="student-cell">

        <div class="student-info">
          <span class="student-name">{{ s.fullName }}</span>
        </div>

      </td>
    </ng-container>

    <!-- ===================== -->
    <!-- Estado de cuota       -->
    <!-- ===================== -->
    <ng-container matColumnDef="paid" *ngIf="proPlan">
      <th mat-header-cell *matHeaderCellDef class="center"> Cuota </th>
      <td mat-cell *matCellDef="let s" class="center">
        <span
          class="pill-button"
          [ngClass]="s.paid ? 'pill-ok' : 'pill-bad'"
          matTooltip="{{ s.paid ? 'Cuota al día' : 'Cuota vencida' }}">
          <span class="pill-icon" aria-hidden="true">
            <mat-icon>
              {{ s.paid ? 'check' : 'close' }}
            </mat-icon>
          </span>
          {{ s.paid ? 'Al día' : 'Vencida' }}
        </span>
      </td>
    </ng-container>

    <!-- ===================== -->
    <!-- Presente              -->
    <!-- ===================== -->
    <ng-container matColumnDef="present">
      <th mat-header-cell *matHeaderCellDef class="center">
        Presente
      </th>
      <td mat-cell *matCellDef="let s" class="center">
        <button
          type="button"
          class="presence-icon"
          (click)="toggleAttendance(s.id, !getMark(s.id))"
          [attr.aria-pressed]="getMark(s.id)">
          <mat-icon
            class="payment-icon"
            [ngClass]="getMark(s.id) ? 'paid' : 'unpaid'">
            {{ getMark(s.id) ? 'check_circle' : 'cancel' }}
          </mat-icon>
          <span class="sr-only">
            {{ getMark(s.id) ? 'Presente' : 'Ausente' }}
          </span>
        </button>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="tableColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: tableColumns"></tr>

  </table>
  </div>

  <mat-divider></mat-divider>

  <div class="button-container">
    <button mat-raised-button color="primary" class="action-pill action-primary" (click)="save()">
      <mat-icon>save</mat-icon>
      Guardar
    </button>

    <button
      mat-stroked-button
      color="primary"
      class="action-pill action-qr"
      *ngIf="canGenerateQr()"
      (click)="generateQr()">
      <mat-icon>qr_code_2</mat-icon>
      Generar QR
    </button>

    <button
      mat-raised-button
      color="accent"
      class="action-pill action-accent"
      [routerLink]="['/attendance/view', classId]"
    >
      <mat-icon>visibility</mat-icon>
      Ver asistencia
    </button>

    <button mat-raised-button color="primary" class="action-pill action-warn" (click)="cancel()">
      <mat-icon>cancel</mat-icon>
      Cancelar
    </button>
  </div>

</mat-card>
